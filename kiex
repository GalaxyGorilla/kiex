#!/usr/bin/env bash

base_path="$HOME/.kiex"
build_path="${base_path}/builds"
elixirs_path="${base_path}/elixirs"
elixirs_source_path="\$HOME/.kiex/elixirs"
kiex_url="https://raw.github.com/taylor/kiex/master/kiex"

function usage() {
  me=$(basename $0)
  #echo "$me <list [known]|install <version>|use <version>>"
  echo "$me commands:"
  printf "%b" "    list            - shows currently installed elixirs\n"
  printf "%b" "    list known      - shows available elixirs releases\n"
  printf "%b" "    install version - installs the given release version\n"
  printf "%b" "    use version     - use the given version for this shell\n"
  printf "%b" "    shell version   - use the given version for this shell\n"
  printf "%b" "    default version - sets default version to be used\n"
}

function setup() {
  mkdir -p "${base_path}/"{builds,elixirs}
}

if [ ! -d "${base_path}/builds" -o ! -d "${base_path}/elixirs" ] ; then
  setup
fi

function self_update() {
  mypath=$(dirname $(readlink -f $0))
  cd $mypath
  D=$(date +%Y%m%d.%H%M)
  cp kiex kiex.bak-$D
  curl -qs -o kiex "$kiex_url"
  chmod +x kiex
  echo "kiex instlled in $mypath is now updated"
}

function get_known_elixir_releases() {
  x=$(curl -H "Accept: application/json" -qs https://api.github.com/repos/elixir-lang/elixir/releases |grep '"tag_name":')
  x=${x//\"tag_name\":/}
  x=${x//[\",]/}
  x=${x//v/}

  echo "$x"
}

function list_known() {
  elixir_releases=$(get_known_elixir_releases)
  #elixir_releases=$x

  echo "Known Elixir releases: "
  printf "%b" "${elixir_releases}\n"
}

function valid_known_release() {
  ver="$1"
  get_known_elixir_releases | grep -q "$1" 2> /dev/null
  echo $?
}

function install_elixir() {
  version="$1"
  if [ ! "$(valid_known_release ${version})" = 0 ] ; then
    echo "Unknown Elixir version $version"
    echo "Use 'kiex list known' see known versions"
    exit 1
  fi

  install_path="${elixirs_path}/elixir-${version}"

  cd "$build_path"
  git clone https://github.com/elixir-lang/elixir.git elixir-git 2> /dev/null
  cd elixir-git
  git checkout "v${version}"
  make clean compile
  mkdir -p "$install_path"
  make "PREFIX=$install_path" install
  echo "Installed Elixir version $version"
  create_env_file "$version"
  echo "Load the elixir environment file with: "
  printf "%b" "   "
  printf "%b" "source ${elixirs_source_path}/elixir-${version}.env\n"
}

function create_env_file() {
  new_ver="$1"
  new_file="${elixirs_path}/elixir-${new_ver}.env"
  new_path="${elixirs_path}/elixir-${new_ver}/bin"
  new_mix_path="${elixirs_path}/elixir-${new_ver}/ebin"
  if [ -f "$new_file" ] ; then
    mv -f "$new_file" "${new_file}.old"
  fi
cat <<EOF> $new_file
export ELIXIR_VERSION="$new_ver"
export PATH="${elixirs_source_path}/elixir-${new_ver}/bin:\$PATH"
export MIX_PATH="${elixirs_source_path}/elixir-${new_ver}/bin:\$MIX_PATH"
EOF
}

function find_elixir_ver() {
  target_elixir="$1"
  
  elixirs=($(
    cd "$elixirs_path"
    find . -maxdepth 1 -mindepth 1 -type d 2> /dev/null | sort
    ))

  #TODO: reset version to nothing if problems arise
  for version in "${elixirs[@]//.\/}"
  do
    if [[ ! -x "$elixirs_path/$version/bin/elixir" ]]
    then
      continue
    elif [[ ! -f "$elixirs_path/${version}.env"  ]]
    then
      continue
    elif [ ! "$version" = "$target_elixir" -a ! "${version}" = "elixir-${target_elixir}" ]
    then
      continue
    else
      break
    fi
  done
  echo $version
}

function use_elixir() {
  target_elixir="$1"
  version=$(find_elixir_ver "$target_elixir")

  echo "Load the elixir environment file with: "
  printf "%b" "   "
  printf "%b" "source ${elixirs_source_path}/${version}.env\n"
}

function elixir_subshell() {
  target_elixir="$1"
  version=$(find_elixir_ver "$target_elixir")

  echo "Starting sub-shell with elixir version $version"
  source "${elixirs_path}/${version}.env"
  exec $SHELL
}

function set_default_elixir() {
  target_elixir="$1"
  version=$(find_elixir_ver "$target_elixir")

  if [ -e ${elixirs_path}/.default ] ; then 
    if [ -L ${elixirs_path}/.default ] ; then 
      rm ${elixirs_path}/.default
    else
      echo "The file ${elixirs_path}/.default should not exists! Fix and try again."
      exit 1
    fi
  fi
  ln -s "${elixirs_path}/${version}.env" "${elixirs_path}/.default"
  echo "Default Elixir version set to $version"
  echo "Load right now with: source $elixirs_source_path/.default"
}

function list_elixirs() {
  typeset current_elixir elixirs version selected system_elixir system_version \
    default_elixir string binary

  if [ -e "$elixirs_path"/.default ] ; then
    default_elixir="elixir-$(source $elixirs_path/.default ; echo $ELIXIR_VERSION)"
  fi

  if [ -n "$(which iex)" ] ; then
    v=$(iex --version 2> /dev/null|grep -v 'Warning: could not run')
    current_elixir="elixir-${v/Elixir /}"
  fi

  elixirs=($(
    cd "$elixirs_path"
    find . -maxdepth 1 -mindepth 1 -type d 2> /dev/null | sort
    #find . -maxdepth 1 -mindepth 1 -type d | sed -e 's#./##g'
    ))

  #for version in "${elixirs//.\/}"
  for version in "${elixirs[@]//.\/}"
  do
    if [[ ! -x "$elixirs_path/$version/bin/elixir" ]]
    then
      continue
    fi

    if [[ "$version" = "$current_elixir" && "$version" = "$default_elixir" ]]
    then
      printf "%b" "=* "
    elif [[ "$version" = "$current_elixir" ]]
    then
      printf "%b" "=> "
    elif [[ "$version" = "$default_elixir" ]]
    then
      printf "%b" " * "
    else
      printf "%b" "   "
    fi

    printf "%b" "$version"
    printf "%b" "\n"
  done

  if (( ${#elixirs[@]} == 0 ))
  then
    printf "%b" "
# No kiex elixirs installed yet. Try 'elixir install <version>'.
"
  else
    if [[ -z "${default_elixir}" ]]
    then
      printf "%b" "
# Default elixir not set. Try 'kiex default <version>'.
"
    fi
    printf "%b" "
# => - current
# =* - current && default
#  * - default
"
  fi

  printf "%b" "\n"
}

action="$1"
shift

if [ -z "$action" ] ; then
  usage
  exit 0
fi

case $action in
  list)
    if [ -z "$1" ]
    then
      printf "%b" "\nkiex elixirs\n\n"
      list_elixirs
    elif [ "$1" = "known" -o "$1" = "releases" ]
    then
      list_known
    else
      usage
      exit 1
    fi
    ;;
  install)
    [[ -z "$1" ]] && usage && exit 1
    install_elixir "$1"
    ;;
  use)
    [[ -z "$1" ]] && usage && exit 1
    use_elixir "$1"
    ;;
  default)
    [[ -z "$1" ]] && usage && exit 1
    set_default_elixir "$1"
    ;;
  shell)
    [[ -z "$1" ]] && usage && exit 1
    elixir_subshell "$1"
    ;;
  envfile)
    [[ -z "$1" ]] && exit 1
    create_env_file "$1"
    ;;
  selfupdate|update_self)
    self_update
    exit 0
    ;;
  *)
    usage
    exit
    ;;
esac
